<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    .info { background-color: #d1ecf1; border-color: #bee5eb; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
    .summary { font-size: 18px; font-weight: bold; margin: 20px 0; padding: 15px; border-radius: 5px; }
    .summary.success { background-color: #d4edda; }
    .summary.error { background-color: #f8d7da; }
  </style>
</head>
<body>
  <h1>üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è HUF Price Converter</h1>
  
  <div class="test-section info">
    <h2>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
    <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:</p>
    <ol>
      <li>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API openexchangerates.org</li>
      <li>–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º—É–ª –∫—É—Ä—Å–æ–≤</li>
      <li>–ü–∞—Ä—Å–∏–Ω–≥ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω</li>
      <li>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (12 —á–∞—Å–æ–≤)</li>
    </ol>
    <button onclick="runAllTests()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
  </div>

  <div id="results"></div>

  <script>
    const APP_ID = "6f5840b11d7243d8a8857734a0245984";
    const UPDATE_INTERVAL_HOURS = 12;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –∏–∑ API
    async function fetchExchangeRates() {
      try {
        const url = `https://openexchangerates.org/api/latest.json?app_id=${APP_ID}`;
        const response = await fetch(url);
        const data = await response.json();
        const rates = data.rates;
        
        if (!rates.HUF || !rates.EUR || !rates.RSD) {
          throw new Error("One of currencies (HUF, EUR, RSD) not found in API");
        }

        const rate_hufeur = rates.EUR / rates.HUF;
        const rate_eurrsd = rates.RSD / rates.EUR;

        return { rate_hufeur, rate_eurrsd };
      } catch (error) {
        throw error;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    function shouldUpdateRates(lastUpdateDate) {
      if (!lastUpdateDate) return true;
      const now = new Date();
      const lastUpdate = new Date(lastUpdateDate);
      const diffInHours = (now - lastUpdate) / (1000 * 60 * 60);
      return diffInHours >= UPDATE_INTERVAL_HOURS;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–æ—Ä–º—É–ª
    function parseFormula(formula) {
      if (!formula || typeof formula !== 'string') return NaN;
      if (!/^[*/+\-]/.test(formula)) {
        formula = '*' + formula;
      }
      const safeExpr = '1' + formula;
      if (!/^[\d+\-*/().\s]+$/.test(safeExpr)) {
        return NaN;
      }
      const tokens = formula.match(/[*/+\-]?\s*[\d.]+/g);
      if (!tokens) return NaN;
      let result = 1;
      for (let token of tokens) {
        token = token.trim();
        const value = parseFloat(token.slice(1));
        if (isNaN(value)) return NaN;
        const op = token[0];
        if (op === '*') result *= value;
        else if (op === '/') result /= value;
        else if (op === '+') result += value;
        else if (op === '-') result -= value;
        else result *= parseFloat(token);
      }
      return result;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ü–µ–Ω
    function parseAndConvertPrice(text, rate_hufeur, rate_eurrsd) {
      const match = text.match(/([\d\s]+)\s*Ft/);
      if (!match) {
        const match = text.match(/([\d,\s]+)\s*‚Ç¨/);
        if (!match) {
          return null;
        }
        const eur = parseInt(match[1].replace(/\s/g, '').replace(',', ''));
        const converted_rsd = (eur * rate_eurrsd).toFixed(2);
        return `~RSD${converted_rsd}`;
      }
      const huf = parseInt(match[1].replace(/\s/g, ''));
      const converted = (huf * rate_hufeur).toFixed(2);
      const converted_rsd = (converted * rate_eurrsd).toFixed(2);
      return `~‚Ç¨${converted} / ~RSD${converted_rsd}`;
    }

    let testResults = {
      api: false,
      formulas: false,
      prices: false,
      interval: false
    };

    async function runAllTests() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<p>‚è≥ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...</p>';

      let html = '';

      // –¢–µ—Å—Ç 1: API
      html += '<div class="test-section"><h2>1. –¢–µ—Å—Ç API</h2>';
      try {
        const rates = await fetchExchangeRates();
        html += `<div class="success">
          <p>‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p>
          <p>HUF ‚Üí EUR: ${rates.rate_hufeur.toFixed(8)}</p>
          <p>EUR ‚Üí RSD: ${rates.rate_eurrsd.toFixed(4)}</p>
        </div>`;
        testResults.api = true;
      } catch (error) {
        html += `<div class="error">
          <p>‚ùå –û—à–∏–±–∫–∞ API: ${error.message}</p>
        </div>`;
        testResults.api = false;
      }
      html += '</div>';

      // –¢–µ—Å—Ç 2: –§–æ—Ä–º—É–ª—ã
      html += '<div class="test-section"><h2>2. –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–æ—Ä–º—É–ª</h2>';
      const formulaTests = [
        { formula: "/392*0.917", expected: 1/392*0.917 },
        { formula: "*117.5", expected: 117.5 },
        { formula: "/400*0.9*1.05", expected: 1/400*0.9*1.05 }
      ];
      let formulasOk = true;
      formulaTests.forEach(test => {
        const result = parseFormula(`1${test.formula}`);
        const isOk = Math.abs(result - test.expected) < 0.0001;
        if (!isOk) formulasOk = false;
      });
      if (formulasOk) {
        html += '<div class="success"><p>‚úÖ –í—Å–µ —Ñ–æ—Ä–º—É–ª—ã –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p></div>';
        testResults.formulas = true;
      } else {
        html += '<div class="error"><p>‚ùå –û—à–∏–±–∫–∏ –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ —Ñ–æ—Ä–º—É–ª</p></div>';
        testResults.formulas = false;
      }
      html += '</div>';

      // –¢–µ—Å—Ç 3: –ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω
      html += '<div class="test-section"><h2>3. –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ü–µ–Ω</h2>';
      const priceTests = ["15 990 Ft", "129,99 ‚Ç¨", "45 000 Ft"];
      let pricesOk = true;
      priceTests.forEach(price => {
        const result = parseAndConvertPrice(price, 0.00238, 117);
        if (!result) pricesOk = false;
      });
      if (pricesOk) {
        html += '<div class="success"><p>‚úÖ –í—Å–µ —Ü–µ–Ω—ã –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p></div>';
        testResults.prices = true;
      } else {
        html += '<div class="error"><p>‚ùå –û—à–∏–±–∫–∏ –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ —Ü–µ–Ω</p></div>';
        testResults.prices = false;
      }
      html += '</div>';

      // –¢–µ—Å—Ç 4: –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      html += '<div class="test-section"><h2>4. –¢–µ—Å—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h2>';
      const now = new Date().toISOString();
      const past12h = new Date(Date.now() - 11 * 60 * 60 * 1000).toISOString();
      const past13h = new Date(Date.now() - 13 * 60 * 60 * 1000).toISOString();
      
      const test1 = shouldUpdateRates(null); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
      const test2 = shouldUpdateRates(past12h); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å false (< 12 —á–∞—Å–æ–≤)
      const test3 = shouldUpdateRates(past13h); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true (>= 12 —á–∞—Å–æ–≤)
      
      if (test1 && !test2 && test3) {
        html += '<div class="success"><p>‚úÖ –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!</p></div>';
        testResults.interval = true;
      } else {
        html += `<div class="error">
          <p>‚ùå –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∏–∫–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞</p>
          <p>–¢–µ—Å—Ç 1 (null): ${test1 ? '‚úÖ' : '‚ùå'}</p>
          <p>–¢–µ—Å—Ç 2 (< 12—á): ${!test2 ? '‚úÖ' : '‚ùå'}</p>
          <p>–¢–µ—Å—Ç 3 (>= 12—á): ${test3 ? '‚úÖ' : '‚ùå'}</p>
        </div>`;
        testResults.interval = false;
      }
      html += '</div>';

      // –ò—Ç–æ–≥–∏
      const allPassed = Object.values(testResults).every(r => r === true);
      html += `<div class="summary ${allPassed ? 'success' : 'error'}">
        <h2>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <p>API: ${testResults.api ? '‚úÖ' : '‚ùå'}</p>
        <p>–§–æ—Ä–º—É–ª—ã: ${testResults.formulas ? '‚úÖ' : '‚ùå'}</p>
        <p>–¶–µ–Ω—ã: ${testResults.prices ? '‚úÖ' : '‚ùå'}</p>
        <p>–ò–Ω—Ç–µ—Ä–≤–∞–ª: ${testResults.interval ? '‚úÖ' : '‚ùå'}</p>
        <h3>${allPassed ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.' : '‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ.'}</h3>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      setTimeout(runAllTests, 500);
    });
  </script>
</body>
</html>

